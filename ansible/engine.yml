# Initialise ACAEngine
- name: Engine Initialisation
  hosts: all

  tasks:
    - name: Create Node document
      shell: sg docker -c "docker exec engine rake migrate:nodes"
      register: result
      until: result.rc == 0
      retries: 9
      delay: 1
      ignore_errors: yes
      
    - name: Add local authority
      shell: sg docker -c "docker exec engine rake domain:add_authority[Engine,http://localhost,{{ engine_password }}]"
      
    - name: Add backoffice app
      shell: sg docker -c "docker exec engine rake domain:add_app[Backoffice,http://localhost:{{ www_port }}]"
      when: www_port != "80"
      
    - name: Add backoffice app on 80
      shell: sg docker -c "docker exec engine rake domain:add_app[Backoffice,http://localhost]"
      when: www_port == "80"
      
    - name: Restart Engine with new settings
      shell: sg docker -c "docker-compose restart engine"
      args:
        chdir: /vagrant

    - name: Scan for Drivers
      shell: sg docker -c "docker exec engine rake discover:drivers"
      register: result
      until: result.rc == 0
      retries: 9
      delay: 1
      ignore_errors: yes

    - name: Create Demo System
      shell: sg docker -c "docker exec engine rake demo:system1"